import streamlit as st
import numpy as np

st.set_page_config(page_title="Tic Tac Toe", page_icon="ğŸ®", layout="centered")

# -------------------------
# Initialize session state
# -------------------------
if "board" not in st.session_state:
    st.session_state.board = np.zeros((3, 3), dtype=int)

if "current" not in st.session_state:
    st.session_state.current = 1

if "game_over" not in st.session_state:
    st.session_state.game_over = False

# -------------------------
# Winner Logic
# -------------------------
def check_winner(b):
    if 3 in np.sum(b, axis=1) or 3 in np.sum(b, axis=0):
        return "X"
    if -3 in np.sum(b, axis=1) or -3 in np.sum(b, axis=0):
        return "O"
    if np.trace(b) == 3 or np.trace(np.fliplr(b)) == 3:
        return "X"
    if np.trace(b) == -3 or np.trace(np.fliplr(b)) == -3:
        return "O"
    if not 0 in b:
        return "DRAW"
    return None

# -------------------------
# Reset Game
# -------------------------
def reset_game():
    st.session_state.board = np.zeros((3, 3), dtype=int)
    st.session_state.current = 1
    st.session_state.game_over = False
    st.rerun()

# -------------------------
# UI
# -------------------------
st.markdown("<h1 style='text-align:center;'>ğŸ® Tic Tac Toe</h1>", unsafe_allow_html=True)
st.write("")

board = st.session_state.board
current = st.session_state.current

symbols = {0: "", 1: "âŒ", -1: "â­•"}

# -------------------------
# Create Game Grid
# -------------------------
for row in range(3):
    cols = st.columns(3)
    for col in range(3):
        if cols[col].button(
            symbols[board[row, col]],
            key=f"{row}-{col}",
            use_container_width=True,
            disabled=st.session_state.game_over
        ):
            if board[row, col] == 0 and not st.session_state.game_over:
                board[row, col] = current
                result = check_winner(board)

                if result is None:
                    st.session_state.current *= -1
                else:
                    st.session_state.game_over = True

                st.rerun()   # ğŸ”¥ Fix for delayed update

# -------------------------
# Show Result
# -------------------------
result = check_winner(board)

if result is not None:
    if result == "DRAW":
        st.warning("ğŸ¤ It's a Draw!")
    else:
        st.success(f"ğŸ† {result} Wins!")
else:
    st.markdown(
        f"<h3 style='text-align:center;'>Current Player: {'âŒ X' if st.session_state.current == 1 else 'â­• O'}</h3>",
        unsafe_allow_html=True
    )

st.write("")
st.button("ğŸ”„ Restart Game", on_click=reset_game, use_container_width=True)
